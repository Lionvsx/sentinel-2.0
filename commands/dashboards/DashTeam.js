const BaseCommand = require('../../utils/structures/BaseCommand');
const Team = require('../../src/schemas/TeamSchema');
const User = require('../../src/schemas/UserSchema');
const Discord = require('discord.js'); 
const { updateGuildMemberCache } = require('../../utils/functions/utilitaryFunctions');
const {
    createButtonActionRow,
    createEmojiButton
} = require('../../utils/functions/messageComponents')

module.exports = class DashRespoCommand extends BaseCommand {
    constructor () {
        super('dashboardteam', 'dashboard', [], {
            usage: "dashboardteam",
            description: "Cr√©e un dashboard pour l'√©quipe de ce salon",
            categoryDisplayName: `<:compass:1137390624090374228> Dashboard`,
            userPermissions: ['ADMINISTRATOR'],
            clientPermissions: [],
            examples: [],
            serverOnly: true,
            admin: true,
            home: true,
            subCommands: false
        });
    }

    async run (client, message, args) {
        const existingTeam = await Team.findOne({ linkedCategoryId: message.channel.parentId })

        if (existingTeam && existingTeam._id) {
            const allRoles = message.guild.roles.cache
            const allMembers = await updateGuildMemberCache(message.guild)
            const linkedRole = allRoles.get(existingTeam.linkedRoleId)

            const Players = await User.find({ onServer: true, isMember: true, role: { $regex: existingTeam._id } })
            const managers = allMembers.filter(member => member.roles.cache.hasAll(linkedRole.id, '622108209175593020', '744234761282650213'))
            const coachs = allMembers.filter(member => member.roles.cache.hasAll(linkedRole.id, '622108099569909762', '744234761282650213'))

        
            const DashBoardTeam = new Discord.MessageEmbed()
                .setColor('#0099ff')
                .setTitle(`${existingTeam.emoji} | DASHBOARD ${existingTeam.name.toUpperCase()}`)
                .setThumbnail('https://cdn.discordapp.com/attachments/624619133799104522/742037500536684574/icon_dashboard.png')
                .setDescription("Panneau de controle pour les managers afin de g√©rer son √©quipe. \nToutes les fonctionnalit√©s sont expliqu√©es ci-dessous:")
                .addFields(
                    { name: `\`\`JEU\`\``, value: `\`\`\`${existingTeam.emoji} | ${existingTeam.game}\`\`\``, inline: false },
                    { name: `\`\`Joueurs\`\``, value: `\`\`\`\n${ Players?.length > 0 ? Players.map(user => user.userTag).join('\n') : 'Aucun' }\`\`\``, inline: true },
                    { name: `\`\`Coachs\`\``, value: `\`\`\`\n${ coachs?.size > 0 ? coachs.map(m => m.user.tag).join('\n') : 'Aucun' }\`\`\``, inline: true },
                    { name: `\`\`Managers\`\``, value: `\`\`\`\n${ managers?.size > 0 ? managers.map(m => m.user.tag).join('\n') : 'Aucun' }\`\`\``, inline: true },
                    { name: '\u200B', value: '\u200B' },
                    { name: '‚ñ∂Ô∏è | START CALL', value: 'D√©marrer l\'appel', inline: true },
                    { name: '‚èπÔ∏è | END CALL', value: "Cl√¥turer l'appel", inline: true },
                    { name: '‚úèÔ∏è | EDIT TEAM', value: "Vous permet de changer le nom ou l'emoji de l'√©quipe", inline: true },
                    { name: '\u200B', value: '\u200B' },
                    { name: '‚öôÔ∏è | MANAGE PLAYER', value: "Ajouter ou retirer un joueur de votre √©quipe", inline: true },
                    { name: 'üì© | INVITE PLAYER', value: "Inviter un joueur **ext√©rieur** √† votre √©quipe", inline: true },
                    { name: 'üîÑ | UPDATE TEAM PERMS', value: "Met √† jour les permissions de vos salons", inline: true },
                )
            const Row1 = createButtonActionRow([
                createEmojiButton(`buttonStartCall|${existingTeam._id}`, 'D√©marrer l\'appel', 'SUCCESS', '‚ñ∂Ô∏è'),
                createEmojiButton(`buttonEndCall|${existingTeam._id}`, 'Arr√™ter l\'appel', 'DANGER', '‚èπÔ∏è'),
                createEmojiButton(`buttonEditTeam|${existingTeam._id}`, 'Modifier votre √©quipe', 'PRIMARY', '‚úèÔ∏è')
            ])
            const Row2 = createButtonActionRow([
                createEmojiButton(`buttonManagePlayer|${existingTeam._id}`, 'G√©rer un joueur', 'SECONDARY', '‚öôÔ∏è'),
                createEmojiButton(`buttonInvitePlayer|${existingTeam._id}`, 'Inviter un joueur', 'SECONDARY', 'üì©'),
                createEmojiButton(`buttonUpdateTeam|${existingTeam._id}`, 'Mettre √† jour les permissions', 'SECONDARY', 'üîÑ'),
            ])
            message.channel.send({
                embeds: [DashBoardTeam],
                components: [Row1, Row2]
            })


        } else message.channel.send(`**<:x_:1137419292946727042> | **Ce channel n'heberge aucune √©quipe !`)
    
        message.delete()

    }
}